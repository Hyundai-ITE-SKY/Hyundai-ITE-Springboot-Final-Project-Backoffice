<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{common/layout::setContent(~{this::content})}">
	<th:block th:fragment="content">
		<div>
			<h5 class="mb-3 text-gray-800">상품 검색</h5>
		</div>
		<!-- 상품 검색 -->
		<div class="card shadow mb-4">
			<div class="card-body table-responsive"
				style="padding-top: 0px; padding-bottom: 0px;">
				<form name="search-form" id="search-form" action="search"
					autocomplete="off">
					<table class="table table-borderless mt-2" style="font-size: 14px;">
						<tr>
							<td class="col-1">검색</td>
							<td class="input-group">
								<div class="input-group-prepend">
									<th:block th:if="${#strings.isEmpty(type)}">
										<select class="form-control form-control-sm" name="type">
											<option value="" selected>검색 분류</option>
											<option value="pname">상품명</option>
											<option value="pid">상품 코드</option>
											<option value="bname">브랜드</option>
										</select>
									</th:block>

									<th:block th:if="${not #strings.isEmpty(type)}">
										<select class="form-control form-control-sm" name="type">
											<option value="">검색 분류</option>
											<option value="pname" th:selected="${type}=='pname'">상품명</option>
											<option value="pid" th:selected="${type}=='pid'">상품
												코드</option>
											<option value="bname" th:selected="${type}=='bname'">브랜드</option>
										</select>
									</th:block>
								</div> <input type="text" name="keyword"
								class="form-control form-control-sm"
								th:value="${keyword != null}? ${keyword}:''" />
							</td>
						</tr>
						<tr>
							<td scope="row">카테고리</td>
							<td class="input-group input-group-sm">
								<!-- 검색시 검색 카테고리에 선택하게 하기 위함  -->
								<input type="hidden" id="originClarge" th:value="${clarge}"/>
								<input type="hidden" id="originCmedium" th:value="${cmedium}"/>
								<input type="hidden" id="originCsmall" th:value="${csmall}"/>
								<!-- 끝 -->
								<div class="input-group input-group-sm">
									<select class="custom-select"  id="clargeSelect" onchange="clargeChange(this)" name="clarge">
										<option value="" selected>대분류</option>
										<option th:each="clarge : ${categoryList}" th:value="${clarge.clarge}" th:text="${clarge.clarge}"></option>
									</select>
									<select class="custom-select" id="cmediumSelect" onchange="cmediumChange(this)" name="cmedium">
										<option value="" selected>중분류</option>
									</select>
									<select class="custom-select" id="csmallSelect" name="csmall">
										<option value="" selected>소분류</option>
									</select>
								</div>
								<script th:inline="javascript">
								let category;
							
								function clargeChange(e){
									let clarge = e.value;
									$('#cmediumSelect').children('option:not(:first)').remove();
									$('#csmallSelect').children('option:not(:first)').remove();
									
									if (category != null) {
										for(let i=0; i<category.length; i++){
											if(clarge === category[i].clarge){
												for(x in category[i].cmedium){
													$('<option/>', {
														'text' : category[i].cmedium[x].cmedium,
														'value' : category[i].cmedium[x].cmedium
													}).appendTo('#cmediumSelect');
												}
											}
										}
									}
								}
								
								function cmediumChange(e){
									let clarge = $('#clargeSelect option:selected').val();
									let cmedium = e.value;
									$('#csmallSelect').children('option:not(:first)').remove();
									
									if(category!=null){
										for(let i=0; i<category.length; i++){
											if(clarge===category[i].clarge){
												for(x in category[i].cmedium){
													if(cmedium ===category[i].cmedium[x].cmedium){
														for(y in category[i].cmedium[x].csmall){
															$('<option/>', {
																'text' : category[i].cmedium[x].csmall[y],
																'value' : category[i].cmedium[x].csmall[y]
															}).appendTo('#csmallSelect');
														}
													}
												}
											}
										}
									}
									
								}
								$(document).ready(function(){
									$.ajax({
										url: "http://localhost:82/product/category",
										method: "get",
									}).done((data) => {
										category = data["category"];
										let clarge = $('#originClarge').val();
										let cmedium = $('#originCmedium').val();
										let csmall = $('#originCsmall').val();
										console.log(clarge, cmedium, csmall);
										
										clargeChange(clarge);
										$('#cmediumSelect').val(cmedium);
										
										cmediumChange(cmedium);
										$('#csmallSelect').val(csmall);
									});
								})
							</script>
							</td>
						</tr>
					</table>
					<div class="d-flex justify-content-center">
						<button class="btn btn-sm text-white mb-2"
							style="background-color: #2D3134" onclick="getSearchList()">검색</button>
					</div>
				</form>
				<script th:inline="javascript">
					function getSearchList(){
						$('#search-form').submit();
					}
				</script>
			</div>
		</div>
		<!-- 상품 목록 -->
		<div>
			<h5 class="mb-3 text-gray-800">상품 목록</h5>
		</div>
		<div class="card shadow mb-4">
			<div class="table-responsive">
				<table class="table table-hover table-bordered mb-0 text-center"
					id="producttable" style="font-size: 14px;">
					<thead>
						<tr>
							<th class="col-1">상품 번호</th>
							<th>대분류</th>
							<th>중분류</th>
							<th>소분류</th>
							<th class="col-2">브랜드</th>
							<th class="col-2">상품 코드</th>
							<th class="col-3">상품명</th>
							<th class="col-2">상품 가격</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="product : ${products}"
							th:onclick="'location.href=\'' + @{/product/detail(pid=${product.pid})} + '\''">
							<td>[[${product.pno}]]</td>
							<td>[[${product.clarge}]]</td>
							<td>[[${product.cmedium}]]</td>
							<td>[[${product.csmall}]]</td>
							<td>[[${product.bname}]]</td>
							<td>[[${product.pid}]]</td>
							<td>[[${product.pname}]]</td>
							<td>[[${#numbers.formatInteger(product.pprice, 3,
								'COMMA')}]]원</td>
						</tr>

						<tr>
							<td colspan="8">
								<ul class="pagination justify-content-center mb-1 mt-1">
									<th:block th:if="${#strings.isEmpty(keyword)}">
										<li class="page-item"><a class="page-link"
											th:href="@{/product/list(pageNo=1)}">처음</a></li>
										<li class="page-item" th:if="${pager.groupNo>1}"><a
											th:href="@{/product/list(pageNo=${pager.startPageNo-1})}"
											class="page-link">이전</a></li>
										<th:block
											th:each="i : ${#numbers.sequence(pager.startPageNo, pager.endPageNo)}">
											<li class="page-item"><a
												th:classappend="(${pager.pageNo != i})?'page-link':'btn btn-primary'"
												th:href="@{/product/list(pageNo=${i})}">[[${i}]]</a></li>
										</th:block>
										<li class="page-item"
											th:if="${pager.groupNo<pager.totalGroupNo}"><a
											th:href="@{/product/list(pageNo=${pager.endPageNo+1})}"
											class="page-link">이후</a></li>
										<li class="page-item"><a class="page-link"
											th:href="@{/product/list(pageNo=${pager.totalPageNo})}">마지막</a>
										</li>
									</th:block>

									<th:block th:if="${not #strings.isEmpty(keyword)}">
										<li class="page-item"><a class="page-link"
											th:href="@{/product/search(type=${type},keyword=${keyword},pageNo=1)}">처음</a>
										</li>
										<li class="page-item" th:if="${pager.groupNo>1}"><a
											th:href="@{/product/search(type=${type},keyword=${keyword},pageNo=${pager.startPageNo-1})}"
											class="page-link">이전</a></li>
										<th:block
											th:each="i : ${#numbers.sequence(pager.startPageNo, pager.endPageNo)}">
											<li class="page-item"><a
												th:classappend="(${pager.pageNo != i})?'page-link':'btn btn-primary'"
												th:href="@{/product/search(type=${type},keyword=${keyword},pageNo=${i})}">[[${i}]]</a>
											</li>
										</th:block>
										<li class="page-item"
											th:if="${pager.groupNo<pager.totalGroupNo}"><a
											th:href="@{/product/search(type=${type},keyword=${keyword}, pageNo=${pager.endPageNo+1})}"
											class="page-link">이후</a></li>
										<li class="page-item"><a class="page-link"
											th:href="@{/product/search(type=${type},keyword=${keyword}, pageNo=${pager.totalPageNo})}">마지막</a>
										</li>
									</th:block>
								</ul>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</th:block>
</th:block>
</html>